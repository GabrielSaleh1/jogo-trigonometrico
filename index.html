<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RPG Trigonom√©trico ‚Äî Jornada Guiada (UX+Did√°tica)</title>
  <style>
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
      color: #eef2ff;
      background: linear-gradient(180deg,#0b0e2a 0%, #101348 50%, #5b1b6d 100%);
      line-height: 1.5;
    }
    .page { min-height: 100vh; padding: 24px; position: relative; overflow: hidden; }
    .wrap { max-width: 1100px; margin: 0 auto; position: relative; z-index: 1; }

    .stars { position: absolute; inset: 0; z-index: 0; opacity: .35; pointer-events: none; }

    .card {
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.2);
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,.25);
      padding: 20px;
    }
    .title {
      font-weight: 800;
      font-size: 20px;
      margin: 0 0 12px;
      color: #fff;
      text-shadow: 0 1px 3px rgba(255,255,255,.6);
      display:flex;align-items:center;gap:12px;flex-wrap:wrap;
    }
    .title .pill { font-size:12px; font-weight:900; background: rgba(255,255,255,.16); border:1px solid rgba(255,255,255,.28); padding:4px 10px; border-radius:999px; }

    .dialog {
      display: flex; gap: 12px; align-items: flex-start;
      background: rgba(255,255,255,.1);
      border: 1px solid rgba(255,255,255,.2);
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 6px 16px rgba(0,0,0,.25);
      margin-bottom: 10px;
    }
    .avatar { width: 48px; height: 48px; border-radius: 999px; background: #e879f9; display: grid; place-items: center; box-shadow: inset 0 0 12px rgba(0,0,0,.25); font-size: 22px; }
    .dialog p { margin: 0; white-space: pre-line; color: #f8fafc; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,.8); letter-spacing: .2px; }

    .warning { margin-top: 8px; background: rgba(220,38,38,.3); color: #ffe4e6; font-weight: 800; border: 1px solid rgba(248,113,113,.7); border-radius: 12px; padding: 10px 12px; box-shadow: 0 1px 2px rgba(0,0,0,.8); font-size: 14px; }

    .objective { margin-top: 8px; opacity: .95; font-size: 14px; font-weight: 700; text-shadow: 0 1px 2px rgba(0,0,0,.8); }

    .grid { display: grid; gap: 24px; margin-top: 10px; }
    @media (min-width: 980px) { .grid { grid-template-columns: 1fr 360px; } }

    .panel { background: rgba(255,255,255,.1); border: 1px solid rgba(255,255,255,.2); border-radius: 12px; padding: 12px; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,.8); }
    .panel .muted { opacity: .9; margin-bottom: 6px; }

    .svg-wrap { display: flex; align-items: center; justify-content: center; }
    .angle-label { fill: #fff; font-weight: 800; }

    input[type="range"] { width: 100%; accent-color: #f472b6; }
    .btn { border: none; cursor: pointer; padding: 10px 14px; border-radius: 10px; color: #fff; font-weight: 800; background: #c026d3; box-shadow: 0 10px 24px rgba(192,38,211,.35); transition: transform .06s ease, box-shadow .2s; }
    .btn:hover { box-shadow: 0 14px 28px rgba(251,113,133,.55); }
    .btn:active { transform: translateY(1px); }
    .btn.slate { background: #475569; box-shadow: 0 10px 24px rgba(71,85,105,.4); }
    .btn.green { background:#10b981; }
    .btn.orange { background:#f59e0b; }
    .center { text-align: center; font-weight: 800; font-size: 20px; margin-top: 10px; text-shadow: 0 1px 3px rgba(255,255,255,.6); }

    .row { display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-weight:800; padding:2px 8px; border-radius:8px; border:1px solid rgba(255,255,255,.35); background: rgba(255,255,255,.1); }
  </style>
</head>
<body>
  <div class="page">
    <svg class="stars"></svg>

    <div class="wrap">
      <div class="card">
        <h2 id="title" class="title">Pr√≥logo ‚Äî Cosmos <span id="modePill" class="pill">Jornada</span></h2>

        <div id="dialog" class="dialog">
          <div class="avatar">ü™ê</div>
          <p id="message"></p>
        </div>
        <div id="warnings"></div>
        <div id="objective" class="objective"></div>

        <div id="content"></div>
      </div>
    </div>
  </div>

  <script>
    // ==================== Utils ====================
    const toRad = (d) => (d * Math.PI) / 180;
    const clamp = (v,a,b) => Math.max(a, Math.min(b, v));
    const within = (a,b,tol=4) => Math.abs(a-b) <= tol;

    const RAD = (deg) => ({
      0:"0", 30:"œÄ/6", 45:"œÄ/4", 60:"œÄ/3", 90:"œÄ/2",
      120:"2œÄ/3", 135:"3œÄ/4", 150:"5œÄ/6", 180:"œÄ",
      210:"7œÄ/6", 225:"5œÄ/4", 240:"4œÄ/3", 270:"3œÄ/2",
      300:"5œÄ/3", 315:"7œÄ/4", 330:"11œÄ/6"
    }[deg] || "?");

    const COORD = (deg) => {
      const m = {
        0:["1","0"], 30:["‚àö3/2","1/2"], 45:["‚àö2/2","‚àö2/2"], 60:["1/2","‚àö3/2"],
        90:["0","1"], 120:["-1/2","‚àö3/2"], 135:["-‚àö2/2","‚àö2/2"], 150:["-‚àö3/2","1/2"],
        180:["-1","0"], 210:["-‚àö3/2","-1/2"], 225:["-‚àö2/2","-‚àö2/2"], 240:["-1/2","-‚àö3/2"],
        270:["0","-1"], 300:["1/2","-‚àö3/2"], 315:["‚àö2/2","-‚àö2/2"], 330:["‚àö3/2","-1/2"]
      };
      const p = m[deg];
      return p ? `(${p[0]}, ${p[1]})` : "(cosŒ∏, senŒ∏)";
    };

    const cosNum = (deg) => +(Math.cos(toRad(deg)).toFixed(3));
    const sinNum = (deg) => +(Math.sin(toRad(deg)).toFixed(3));

    // ==================== Estado ====================
    // 0=intro, 1=not√°veis, 15=cutscene irm√£os, 2=irm√£os, 3=radianos, 4=coordenadas, 5=final, 99=livre
    let phase = 0;
    let angle = 0;
    let introStep = 0;
    let idx = 0;
    const revealed = []; // √¢ngulos confirmados

    const seqNotaveis = [30,45,60,90];
    // Correspondentes (mesmo √¢ngulo de refer√™ncia) para cada not√°vel
    const correspondentsMap = {
      30: [150, 210, 330],
      45: [135, 225, 315],
      60: [120, 240, 300],
      90: [270]
    };
    const seqIrmaos = [30,45,60,90];
    const tolerance = 4;

    const currentTarget = () =>
      phase === 1 ? (seqNotaveis[idx] ?? null)
      : phase === 2 ? (remainingCorrespondents(seqIrmaos[idx])[0] ?? null)
      : null;

    const circDiff = (a,b) => {
      const d = Math.abs(a-b) % 360; return d>180 ? 360-d : d;
    };

    const proximityStage = (cur, target) => {
      if (target==null) return "neutral";
      const d = circDiff(cur, target);
      if (d <= 5) return "perfect";
      if (d <= 12) return "near";
      return "far";
    };

    const proximityText = (cur, target) => {
      const d = circDiff(cur, target);
      if (d > 90) return "Estamos muito longe. Procure outra regi√£o‚Ä¶";
      if (d > 45) return "Longe ainda, continue girando‚Ä¶";
      if (d > 20) return "Aproximando! Siga nesse sentido‚Ä¶";
      if (d > 10) return "Quase entrando na √≥rbita!";
      if (d > 5)  return "Quase l√°! Ajuste fino‚Ä¶";
      return "Isso! Voc√™ est√° praticamente em cima do ponto.";
    };

    const regionWarnings = (a) => {
      const parts = [];
      if (a > 90 && a < 270) parts.push("‚ö†Ô∏è Cosseno negativo (lado esquerdo do eixo x)");
      if (a > 180) parts.push("‚ö†Ô∏è Seno negativo (abaixo do eixo x)");
      return parts;
    };

    function isAngleRevealed(deg) {
      return revealed.some(r => Math.abs(r - deg) <= 0.5);
    }

    // ==================== Textos ====================
    const introLines = [
`Oi! Eu sou o Cosmos, um pequeno guardi√£o de √≥rbita. üåå
Ontem, uma tempestade de dados rasgou o c√©u e... POOF! üí• o nosso C√≠rculo Trigonom√©trico se despeda√ßou!`,
`Esse c√≠rculo √© muito importante! Ele √© como um mapa c√≥smico onde cada ponto conta a hist√≥ria de um √¢ngulo. ‚≠ï`,
`Voc√™ j√° conhece os √¢ngulos, n√©? Pois bem, aqui no meu mundo, a gente tamb√©m fala uma outra l√≠ngua: a dos radianos! Eles s√£o como uma tradu√ß√£o m√°gica dos √¢ngulos ‚Äî outra forma de medir o mesmo giro, o mesmo caminho pelo c√≠rculo.`,
`E tem mais! Cada pontinho desse c√≠rculo guarda uma coordenada especial, formada por dois n√∫meros: o cosseno e o seno. Juntos, eles dizem exatamente onde o √¢ngulo mora dentro do c√≠rculo.`,
`Ah, e o mais incr√≠vel: o nosso c√≠rculo tem raio igual a 1. ‚ú®
Isso faz dele um c√≠rculo perfeito ‚Äî um lugar onde cada posi√ß√£o j√° mostra o valor exato das coordenadas, sem precisar de nenhuma conta complicada!`,
`Ent√£o... que tal me ajudar a reconstruir o C√≠rculo Trigonom√©trico e devolver a harmonia ao cosmos? üöÄ`
    ];

    const explicacaoCoordenadas =
`Cada ponto do nosso c√≠rculo tem uma coordenada especial ‚Äî dois n√∫meros m√°gicos: o cosseno (cos) e o seno (sen).
O cosseno representa o quanto o ponto anda no eixo x (para os lados), e o seno mostra o quanto ele sobe ou desce no eixo y.
Como o raio do c√≠rculo √© 1, esses valores sempre ficam entre -1 e 1.
Assim, cada posi√ß√£o no c√≠rculo revela exatamente onde o √¢ngulo vive! üå†`;

    // ==================== DOM helpers ====================
    const $title = document.getElementById('title');
    const $modePill = document.getElementById('modePill');
    const $message = document.getElementById('message');
    const $warnings = document.getElementById('warnings');
    const $objective = document.getElementById('objective');
    const $content = document.getElementById('content');
    const setMessage = (t) => $message.textContent = t;

    function renderWarningsUI(a) {
      const warns = (phase===1||phase===2||phase===99) ? regionWarnings(a) : [];
      $warnings.innerHTML = warns.length
        ? `<div class="warning">${warns.join(" ‚Ä¢ ")}</div>`
        : "";
    }

    // ==================== UI ====================
    function buildIntro() {
      $title.firstChild.textContent = "Pr√≥logo ‚Äî Cosmos ";
      $modePill.textContent = 'Jornada';
      setMessage(introLines[introStep]);
      $warnings.innerHTML = "";
      $objective.textContent = "";

      $content.innerHTML = `
        <div class="row">
          <div style="display:flex;gap:12px;flex-wrap:wrap">
            <button class="btn slate" id="btnBack" ${introStep===0?"disabled":""}>Voltar</button>
            <button class="btn" id="btnNext">${introStep<introLines.length-1 ? "Avan√ßar" : "Come√ßar reconstru√ß√£o"}</button>
          </div>
        </div>
      `;

      document.getElementById('btnBack')?.addEventListener('click', () => { introStep = Math.max(0, introStep-1); buildIntro(); });
      document.getElementById('btnNext').addEventListener('click', () => {
        if (introStep < introLines.length-1) { introStep++; buildIntro(); }
        else { phase = 1; setMessage("Vamos reconstruir o c√≠rculo. Gire a seta at√© o primeiro ponto ‚Äî eu aviso quando estiver perto!"); buildPhaseCircle(); }
      });
    }

    // ============ Render do c√≠rculo ============
    function circleSVG(angleDeg, revealedAngles, target, showAngleBadge = true) {
      const W = 440, H = 440;
      const M = 16;
      const R = 160, cx = 220, cy = 220;
      const rad = toRad(angleDeg);
      const x = cx + R*Math.cos(rad);
      const y = cy - R*Math.sin(rad);

      const stg = proximityStage(angleDeg, target);
      const arcColor = stg==='perfect' ? '#10b981' : stg==='near' ? '#f59e0b' : '#ef4444';
      const pointerColor = arcColor;

      const clampX = (vx) => Math.max(M, Math.min(vx, W - M));
      const clampY = (vy) => Math.max(M, Math.min(vy, H - M));

      const quadFill = (q) => ({1:'rgba(16,185,129,.12)',2:'rgba(244,114,182,.12)',3:'rgba(34,197,94,.10)',4:'rgba(250,204,21,.10)'}[q]);
      const wedge = (start) => {
        const rs = toRad(start), re = toRad(start+90);
        const large = 0, sweep = 1;
        const sx = cx + R*Math.cos(rs), sy = cy - R*Math.sin(rs);
        const ex = cx + R*Math.cos(re), ey = cy - R*Math.sin(re);
        return `M ${cx} ${cy} L ${sx} ${sy} A ${R} ${R} 0 ${large} ${sweep} ${ex} ${ey} Z`;
      };

      const labelAngle = `${angleDeg}¬∞`;

      const revealedDots = revealedAngles.map(deg => {
        const r = toRad(deg);
        const px = cx + R*Math.cos(r);
        const py = cy - R*Math.sin(r);
        const labelOffset = 18;
        const lx = px + Math.cos(r) * labelOffset;
        const ly = py - Math.sin(r) * labelOffset;
        return `
          <g>
            <circle cx="${px}" cy="${py}" r="7" fill="#34d399" stroke="#fff"/>
            <text x="${lx}" y="${ly}" class="angle-label" font-size="12" text-anchor="middle" dominant-baseline="middle" style="paint-order: stroke; stroke: rgba(0,0,0,.6); stroke-width: 3;">${deg}¬∞</text>
          </g>`;
      }).join("");

      // proje√ß√µes
      const px = x, py = y;
      const projLines = `
        <line x1="${px}" y1="${py}" x2="${px}" y2="${cy}" stroke="#f97316" stroke-dasharray="6 4"/>  
        <line x1="${px}" y1="${cy}" x2="${cx}" y2="${cy}" stroke="#60a5fa" stroke-dasharray="6 4"/>  
      `;

      // labels com clamp para n√£o cortar
      const onRight = Math.cos(rad) >= 0;
      const sinAnchor = onRight ? 'end' : 'start';
      const sinX = clampX(onRight ? (px - 12) : (px + 12));
      const sinY = clampY((py + cy) / 2 - 6);
      const cosX = clampX((px + cx) / 2);
      const cosY = clampY(cy + 16);

      const projLabels = `
        <text x="${cosX}" y="${cosY}" fill="#93c5fd" font-weight="900" text-anchor="middle" style="paint-order: stroke; stroke: rgba(0,0,0,.65); stroke-width: 3; pointer-events:none;">cos Œ∏ = ${cosNum(angleDeg)}</text>
        <text x="${sinX}" y="${sinY}" fill="#fdba74" font-weight="900" text-anchor="${sinAnchor}" style="paint-order: stroke; stroke: rgba(0,0,0,.65); stroke-width: 3; pointer-events:none;">sen Œ∏ = ${sinNum(angleDeg)}</text>
      `;

      const arcR = 46;
      return `
      <svg width="${W}" height="${H}" style="overflow: visible">
        <defs>
          <radialGradient id="glow" cx="50%" cy="50%" r="50%">
            <stop offset="0%" stop-color="#a78bfa" stop-opacity="0.55"/>
            <stop offset="100%" stop-color="#a78bfa" stop-opacity="0.05"/>
          </radialGradient>
        </defs>
        <circle cx="${cx}" cy="${cy}" r="${R+14}" fill="url(#glow)"/>

        <path d="${wedge(0)}" fill="${quadFill(1)}"/>
        <path d="${wedge(90)}" fill="${quadFill(2)}"/>
        <path d="${wedge(180)}" fill="${quadFill(3)}"/>
        <path d="${wedge(270)}" fill="${quadFill(4)}"/>

        <line x1="${cx-R-18}" x2="${cx+R+18}" y1="${cy}" y2="${cy}" stroke="#fff" opacity=".25"/>
        <line x1="${cx}" x2="${cx}" y1="${cy-R-18}" y2="${cy+R+18}" stroke="#fff" opacity=".25"/>
        <circle cx="${cx}" cy="${cy}" r="${R}" fill="none" stroke="#fff" opacity=".7" stroke-width="2"/>

        ${revealedDots}

        <path d="M ${cx+arcR} ${cy} A ${arcR} ${arcR} 0 ${angleDeg>180?1:0} 0 ${cx+arcR*Math.cos(rad)} ${cy-arcR*Math.sin(rad)}" fill="none" stroke="${pointerColor}" stroke-width="4"/>

        ${projLines}

        <line x1="${cx}" y1="${cy}" x2="${x}" y2="${y}" stroke="${pointerColor}" stroke-width="2.5"/>
        <circle cx="${x}" cy="${y}" r="7.5" fill="${pointerColor}" stroke="#fff"/>

        ${showAngleBadge ? `
          <g style="pointer-events:none;">
            <rect x="${x+10}" y="${y-28}" rx="8" ry="8" width="68" height="24" fill="${pointerColor}" opacity=".92"/>
            <text x="${x+44}" y="${y-12}" font-weight="900" text-anchor="middle">${labelAngle}</text>
          </g>` : ''}

        ${projLabels}
      </svg>`;
    }

    function buildPhaseCircle() {
      const phaseTitle = (phase===1) ? "Cap√≠tulo 1 ‚Äî Criando o c√≠rculo"
                        : (phase===2) ? "Cap√≠tulo 2 ‚Äî Irm√£os do outro lado"
                        : (phase===3) ? "Cap√≠tulo 3 ‚Äî A tradu√ß√£o em radianos"
                        : (phase===4) ? "Cap√≠tulo 4 ‚Äî As coordenadas do cosmos"
                        : (phase===5) ? "Ep√≠logo ‚Äî Harmonia Restaurada"
                        : (phase===99) ? "Modo Livre ‚Äî Explora√ß√£o"
                        : "";
      $title.firstChild.textContent = phaseTitle + ' ';
      $modePill.textContent = (phase===99) ? 'Livre' : 'Jornada';

      const target = currentTarget();
      renderWarningsUI(angle);

      if (target != null) {
        const base = (phase===2) ? seqIrmaos[idx] : null;
        const rem = (phase===2) ? remainingCorrespondents(base).length : null;
        $objective.textContent = (phase===1)
          ? `Objetivo atual: alcan√ßar ${target}¬∞`
          : (phase===2)
            ? `Objetivo atual: irm√£os correspondentes de ${base}¬∞ ‚Äî faltam ${rem}`
            : '';
      } else {
        $objective.textContent = (phase===99) ? 'Sem objetivos: observe quadrantes, sinais e proje√ß√µes.' : '';
      }

      const stg = proximityStage(angle, target);
      const confirmColor = stg==='perfect' ? 'green' : stg==='near' ? 'orange' : 'slate';

      const showBadge = (phase===99) || isAngleRevealed(angle);
      const showHudAngle = (phase===99) || isAngleRevealed(angle);

      $content.innerHTML = `
        <div class="grid">
          <div>
            <div class="svg-wrap" id="svgWrap">${circleSVG(angle, revealed, target, showBadge)}</div>
            <div class="row" style="margin-top:6px">
              <div style="font-weight:900">
                Œ∏ = <span id="degOut">${showHudAngle ? angle : '?'}</span>¬∞
                | rad ‚âà <span id="radOut">${(toRad(angle)).toFixed(3)}</span>
                | (cosŒ∏, senŒ∏) ‚âà (<span id="cosOut">${cosNum(angle)}</span>, <span id="senOut">${sinNum(angle)}</span>)
              </div>
            </div>
            <input id="slider" type="range" min="0" max="360" step="1" value="${angle}">
            <div class="row" style="margin-top:8px">
              <div style="opacity:.9;font-size:13px">Use <span class="kbd">‚Üê</span> <span class="kbd">‚Üí</span> (¬±1¬∞) e <span class="kbd">Shift</span> + setas (¬±5¬∞).</div>
              <div style="display:flex;gap:8px">
                <button class="btn slate" id="btnReset">Zerar</button>
                ${phase===99 ? '' : `<button class="btn ${confirmColor}" id="confirmBtn">Confirmar posi√ß√£o</button>`}
              </div>
            </div>
          </div>

          <div class="panel">
            <div class="muted">Objetivo atual</div>
            <div style="font-weight:800">${target!=null ? (phase===1 ? `alcan√ßar ${target}¬∞` : `irm√£os correspondentes de ${seqIrmaos[idx]}¬∞`) : (phase===99? 'Explorar livremente' : '‚Äî')}</div>
            <div class="muted" style="margin-top:10px">Exemplos revelados</div>
            ${revealed.length
              ? `<ul style="margin:0;padding-left:18px">${revealed.slice().sort((a,b)=>a-b).map(d=>(`<li> <b>${d}¬∞</b> ‚Äî rad: <b>${RAD(d)}</b>, coord: <b>${COORD(d)}</b></li>`)).join("")}</ul>`
              : `<div class="muted">‚Äî</div>`
            }
          </div>
        </div>
      `;

      const updateHUD = () => {
        const show = (phase===99) || isAngleRevealed(angle);
        document.getElementById('degOut').textContent = show ? angle : '?';
        document.getElementById('radOut').textContent = toRad(angle).toFixed(3);
        document.getElementById('cosOut').textContent = cosNum(angle);
        document.getElementById('senOut').textContent = sinNum(angle);
      };

      document.getElementById('slider').addEventListener('input', (e) => {
        angle = clamp(parseInt(e.target.value,10), 0, 360);
        if (target!=null) setMessage(proximityText(angle, target));
        renderWarningsUI(angle);
        const show = (phase===99) || isAngleRevealed(angle);
        document.getElementById('svgWrap').innerHTML = circleSVG(angle, revealed, target, show);
        updateHUD();
      });

      document.getElementById('btnReset').addEventListener('click', () => {
        angle = 0;
        document.getElementById('slider').value = 0;
        renderWarningsUI(angle);
        const show = (phase===99) || isAngleRevealed(angle);
        document.getElementById('svgWrap').innerHTML = circleSVG(angle, revealed, target, show);
        updateHUD();
      });

      if (phase!==99) {
        document.getElementById('confirmBtn').addEventListener('click', () => {
          if (target==null) return;
          if (within(angle, target, tolerance)) {
            if (!revealed.includes(target)) revealed.push(target);

            if (phase === 2) {
              setMessage(`‚ú® Boa! Voc√™ encontrou um irm√£o de ${seqIrmaos[idx]}¬∞: ${target}¬∞.\nContinue at√© achar todos!`);
            }

            document.getElementById('svgWrap').innerHTML = circleSVG(angle, revealed, target, true);
            const degOut = document.getElementById('degOut'); if (degOut) degOut.textContent = angle;

            if (phase===1) {
              const next = idx + 1;
              if (next >= seqNotaveis.length) {
                setTimeout(() => { setMessage("Maravilha! Voc√™ restaurou os √¢ngulos not√°veis. Agora vamos ca√ßar os irm√£os correspondentes desses √¢ngulos nos outros quadrantes!"); phase = 15; idx = 0; angle = 0; buildCutsceneIrmaos(); }, 700);
              } else {
                idx = next; buildPhaseCircle();
              }
            } else if (phase===2) {
              const base = seqIrmaos[idx];
              const rem = remainingCorrespondents(base);
              if (rem.length === 0) {
                const next = idx + 1;
                if (next >= seqIrmaos.length) {
                  setTimeout(() => { setMessage("Excelente! Vamos traduzir esses √¢ngulos para radianos."); phase = 3; idx = 0; angle = 0; buildRadianos(); }, 700);
                } else {
                  idx = next;
                  setTimeout(() => {
                    setMessage(`Muito bem! Agora procure os irm√£os de ${seqIrmaos[idx]}¬∞.`);
                    buildPhaseCircle();
                  }, 600);
                }
              } else {
                buildPhaseCircle();
              }
            }
          } else {
            setMessage("Ainda n√£o. Observe as proje√ß√µes e os sinais: ajuste com cuidado at√© alinhar.");
          }
        });
      }

      // atalhos de teclado
      window.onkeydown = (ev) => {
        if (ev.key === 'ArrowLeft' || ev.key === 'ArrowRight') {
          const step = ev.shiftKey ? 5 : 1;
          angle = clamp(angle + (ev.key==='ArrowRight' ? step : -step), 0, 360);
          document.getElementById('slider').value = angle;
          if (target!=null) setMessage(proximityText(angle, target));
          renderWarningsUI(angle);
          const show = (phase===99) || isAngleRevealed(angle);
          document.getElementById('svgWrap').innerHTML = circleSVG(angle, revealed, target, show);
          updateHUD();
          ev.preventDefault();
        }
      };
    }

    function buildCutsceneIrmaos() {
      $title.firstChild.textContent = "Cap√≠tulo 2 ‚Äî Irm√£os correspondentes ";
      $modePill.textContent = 'Jornada';
      $warnings.innerHTML = "";
      $objective.textContent = "";
      $content.innerHTML = `
        <div class="panel" style="margin-bottom:12px">
          Alguns √¢ngulos t√™m <b>irm√£os correspondentes</b>: n√£o ficam no mesmo lugar,
          mas t√™m a <b>mesma inclina√ß√£o de base</b> ‚Äî o mesmo ‚Äújeito‚Äù de apontar ‚Äî
          mudando s√≥ o lado/quadrante. Sua miss√£o agora √© encontrar,
          para cada √¢ngulo not√°vel, <b>todos os seus irm√£os</b> nos outros quadrantes.
        </div>
        <div class="row" style="justify-content:flex-end">
          <button class="btn" id="btnIrmaos">Come√ßar a buscar irm√£os</button>
        </div>
      `;
      document.getElementById('btnIrmaos').addEventListener('click', () => {
        phase = 2; idx = 0; angle = 0;
        setMessage("Vamos come√ßar pelo 30¬∞. Encontre um dos seus irm√£os correspondentes e confirme!");
        buildPhaseCircle();
      });
    }

    function remainingCorrespondents(base){
      const list = correspondentsMap[base] || [];
      return list.filter(t => !revealed.some(r => Math.abs(r - t) <= 0.5));
    }

    function buildRadianos() {
  $title.firstChild.textContent = "Cap√≠tulo 3 ‚Äî A tradu√ß√£o em radianos ";
  $modePill.textContent = 'Jornada';
  $warnings.innerHTML = "";
  $objective.textContent = "";

  // texto explicativo inserido aqui
  const explicacaoRadianos = `Como eu tinha dito para voc√™, aqui no nosso universo, os √¢ngulos tamb√©m t√™m outro nome! 
N√≥s chamamos eles de radianos! üåô
Um radiano √© uma forma de medir √¢ngulos usando o pr√≥prio raio do c√≠rculo.
Imagine que o raio se enrola ao redor do c√≠rculo ‚Äî quando o comprimento do arco √© igual ao do raio, temos 1 radiano.
E sabe o que √© ainda mais incr√≠vel? ‚ú®
œÄ radianos (pi radianos) equivalem exatamente a 180¬∞!
Isso quer dizer que meio c√≠rculo ‚Äî de 0¬∞ at√© 180¬∞ ‚Äî √© igual a œÄ radianos.`;

  $content.innerHTML = `
    <p class="panel" style="white-space:pre-line;">${explicacaoRadianos}</p>
    <div class="panel">
      <div class="muted">Tradu√ß√µes em radianos</div>
      ${
        revealed.length
          ? `<ul style="margin:0;padding-left:18px">${revealed
              .slice()
              .sort((a, b) => a - b)
              .map(
                (d) => `<li>‚Ä¢ <b>${d}¬∞</b> ‚Üí <b>${RAD(d)}</b></li>`
              )
              .join("")}</ul>`
          : `<div class="muted">‚Äî</div>`
      }
    </div>
    <div style="display:flex;justify-content:flex-end;margin-top:12px">
      <button class="btn" id="btnCoord">Continuar para coordenadas</button>
    </div>
  `;

  document
    .getElementById("btnCoord")
    .addEventListener("click", () => {
      phase = 4;
      setMessage("Agora vamos ver como as coordenadas funcionam.");
      buildCoordenadas();
    });
}

    function buildCoordenadas() {
      $title.firstChild.textContent = "Cap√≠tulo 4 ‚Äî As coordenadas do cosmos ";
      $modePill.textContent = 'Jornada';
      $warnings.innerHTML = "";
      $objective.textContent = "";
      $content.innerHTML = `
        <p class="panel" style="margin:0 0 10px 0; white-space:pre-line;">${explicacaoCoordenadas}</p>
        <div class="panel">${revealed.slice().sort((a,b)=>a-b).map(d => `‚Ä¢ ${d}¬∞ ‚Üí <b>${COORD(d)}</b>`).join("<br/>")}</div>
        <div style="display:flex;justify-content:space-between;margin-top:12px;gap:8px;flex-wrap:wrap">
          <button class="btn" id="btnFinal">Finalizar jornada</button>
        </div>
      `;
      document.getElementById('btnFinal').addEventListener('click', () => { phase = 5; setMessage("üåü C√≠rculo restaurado! Voc√™ dominou √¢ngulos not√°veis, irm√£os, radianos e coordenadas. Parab√©ns!"); buildFinal(); });
    }

    function buildFinal() {
      $title.firstChild.textContent = "Ep√≠logo ‚Äî Harmonia Restaurada ";
      $modePill.textContent = 'Jornada';
      $warnings.innerHTML = "";
      $objective.textContent = "";
      $content.innerHTML = `<div class="center">üåü C√≠rculo restaurado! Voc√™ dominou √¢ngulos not√°veis, irm√£os, radianos e coordenadas. Parab√©ns!</div>
      <div class="row" style="justify-content:center;margin-top:12px"><button class="btn" id="goFree">Explorar no Modo Livre</button></div>`;
      document.getElementById('goFree').addEventListener('click', () => { phase = 99; angle = 0; buildPhaseCircle(); });
    }

    // ==================== Estrelas ====================
    (function drawStars() {
      const svg = document.querySelector('.stars');
      const N = 120;
      const w = svg.clientWidth || window.innerWidth;
      const h = svg.clientHeight || window.innerHeight;
      svg.setAttribute('viewBox', `0 0 ${w} ${h}`);
      let dots = '';
      for (let i=0;i<N;i++){
        const x = Math.random()*w;
        const y = Math.random()*h;
        const r = Math.random()*1.6 + .3;
        dots += `<circle cx="${x}" cy="${y}" r="${r}" fill="#fff"/>`;
      }
      svg.innerHTML = dots;
      window.addEventListener('resize', drawStars, { once: true });
    })();

    // ==================== Boot + sanity checks ====================
    console.assert(RAD(180) === "œÄ", "RAD(180) deveria ser œÄ");
    console.assert(RAD(90) === "œÄ/2", "RAD(90) deveria ser œÄ/2");
    console.assert(COORD(30) === "(‚àö3/2, 1/2)", "COORD(30) deveria ser (‚àö3/2, 1/2)");
    console.assert(COORD(45) === "(‚àö2/2, ‚àö2/2)", "COORD(45) deveria ser (‚àö2/2, ‚àö2/2)");
    console.assert(COORD(300) === "(1/2, -‚àö3/2)", "COORD(300) deveria ser (1/2, -‚àö3/2)");
    console.assert(COORD(315) === "(‚àö2/2, -‚àö2/2)", "COORD(315) deveria ser (‚àö2/2, -‚àö2/2)");
    console.assert(COORD(330) === "(‚àö3/2, -1/2)", "COORD(330) deveria ser (‚àö3/2, -1/2)");
    console.assert(Math.abs(cosNum(60) - 0.5) < 1e-3, "cos(60¬∞) deveria ser 0.5");
    console.assert(Math.abs(sinNum(30) - 0.5) < 1e-3, "sin(30¬∞) deveria ser 0.5");

    setMessage(introLines[introStep]);
    buildIntro();
  </script>
</body>
</html>
